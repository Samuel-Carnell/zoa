import*as e from"zod";import{extendZodWithOpenApi as t,OpenAPIRegistry as r,OpenApiGeneratorV3 as o}from"@asteasolutions/zod-to-openapi";import s from"@koa/router";import n from"raw-body";t(e);class i{constructor(e){this._endpoint=e}response(e,t){const r=void 0!==t?[e,t]:[e];return this._endpoint.response.push(r),this}query(e){return this._endpoint.query=e,this}handler(e){this._endpoint.handler=e}summary(e){return this._endpoint.summary=e,this}description(e){return this._endpoint.description=e,this}tag(e){return this._endpoint.tags.push(e),this}body(e){return this._endpoint.request.body=e,this}build(){return[this._endpoint]}}function a(e){return{path:{value:e.path.value,parameters:Object.assign({},e.path.parameters)},tags:[...e.tags],middleware:[...e.middleware]}}class u{constructor(e){this._route=e,this._endpointBuilders=[]}use(e){var t;return null===(t=this._route.middleware)||void 0===t||t.push(e),this}path(e,t){const r=a(this._route);var o,s;r.path.value=(o=this._route.path.value,s=e,(o.endsWith("/")?o.slice(0,-1):o)+"/"+(s.startsWith("/")?s.slice(1):s)),r.path.parameters=Object.assign(Object.assign({},this._route.path.parameters),t);const n=new u(r);return this._endpointBuilders.push(n),n}tag(e){return this._route.tags.push(e),this}endpoint(e){const t=Object.assign(Object.assign({},a(this._route)),{method:e,request:{},query:{},response:[],summary:"",description:""}),r=new i(t);return this._endpointBuilders.push(r),r}build(){return this._endpointBuilders.flatMap((e=>e.build()))}}function p(e,t,r,o){return new(r||(r=Promise))((function(s,n){function i(e){try{u(o.next(e))}catch(e){n(e)}}function a(e){try{u(o.throw(e))}catch(e){n(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}u((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;function d(e,t,r,o){e.status=t,void 0!==o&&(e.body=o,e.append("content-type",r))}function c(t,r){const o=[...t.middleware,(e,t)=>{e._internalRequest={},t()}];var s,i,a;Object.entries(t.path.parameters).length>0&&o.push((s=t.path.parameters,(t,r)=>{const o=[],n=e.object(s).safeParse(t.params);if(!n.success)for(const e of n.error.errors)o.push({name:e.path[0],message:e.message});if(!(o.length>0))return t._internalRequest.path=t.params,r();d(t.response,422,"application/problem+json",{type:"https://tools.ietf.org/html/rfc7231#section-6.5.1",title:"Path contained one or more validation errors.",status:422,errors:o})})),void 0!==t.query&&o.push((i=t.query,(t,r)=>{const o=[],s=e.object(i).safeParse(t.query);if(!s.success)for(const e of s.error.errors)o.push({name:e.path[0],message:e.message});if(!(o.length>0))return t._internalRequest.query=t.query,r();d(t.response,422,"application/problem+json",{type:"https://tools.ietf.org/html/rfc7231#section-6.5.1",title:"Query contained one or more validation errors.",status:422,errors:o})})),void 0!==t.request.body&&o.push((a=t.request.body,(e,t)=>p(void 0,void 0,void 0,(function*(){let r;const o=yield n(e.request.req).then((e=>e.toString()));try{r=JSON.parse(o)}catch(t){return void d(e.response,422,"application/problem+json",{type:"https://tools.ietf.org/html/rfc7231#section-6.5.1",title:"Malformed request body.",status:400,detail:"Request body contains invalid JSON."})}const s=[],i=a.safeParse(r);if(!i.success)for(const e of i.error.errors)s.push({name:e.path.join("."),message:e.message});if(!(s.length>0))return e._internalRequest.body=r,t();d(e.response,422,"application/problem+json",{type:"https://tools.ietf.org/html/rfc7231#section-6.5.1",title:"Body contained one or more validation errors.",status:422,errors:s})}))));r[t.method.toLowerCase()](t.path.value,...o,(e=>{if(void 0===t.handler)return void(e.response.status=503);const[r,o]=t.handler(Object.assign(Object.assign({},e.request),{endpoint:t,path:e._internalRequest.path,query:e._internalRequest.query,body:e._internalRequest.body}));d(e.response,r,"application/json",o)}))}const h={202:"Accepted",502:"Bad Gateway",400:"Bad Request",409:"Conflict",100:"Continue",201:"Created",417:"Expectation Failed",424:"Failed Dependency",403:"Forbidden",504:"Gateway Timeout",410:"Gone",505:"HTTP Version Not Supported",418:"I'm a teapot",419:"Insufficient Space on Resource",507:"Insufficient Storage",500:"Internal Server Error",411:"Length Required",423:"Locked",420:"Method Failure",405:"Method Not Allowed",301:"Moved Permanently",302:"Moved Temporarily",207:"Multi-Status",300:"Multiple Choices",511:"Network Authentication Required",204:"No Content",203:"Non Authoritative Information",406:"Not Acceptable",404:"Not Found",501:"Not Implemented",304:"Not Modified",200:"OK",206:"Partial Content",402:"Payment Required",308:"Permanent Redirect",412:"Precondition Failed",428:"Precondition Required",102:"Processing",103:"Early Hints",426:"Upgrade Required",407:"Proxy Authentication Required",431:"Request Header Fields Too Large",408:"Request Timeout",413:"Request Entity Too Large",414:"Request-URI Too Long",416:"Requested Range Not Satisfiable",205:"Reset Content",303:"See Other",503:"Service Unavailable",101:"Switching Protocols",307:"Temporary Redirect",429:"Too Many Requests",401:"Unauthorized",451:"Unavailable For Legal Reasons",422:"Unprocessable Entity",415:"Unsupported Media Type",305:"Use Proxy",421:"Misdirected Request"};function l(t,r){var o;r.registerPath({path:(o=t.path.value,o.split("/").map((e=>e.startsWith(":")?`{${e.slice(1)}}`:e)).join("/")),method:t.method.toLowerCase(),tags:t.tags,request:{params:e.object(t.path.parameters),query:e.object(t.query)},responses:t.response.reduce(((e,t)=>{const[r,o]=t,s=void 0!==o?{"application/json":{schema:o}}:void 0;var n;return e[r]={description:(n=r,h[n]),content:s},e}),{})})}class m extends u{constructor(){super({path:{value:"/",parameters:{}},middleware:[],tags:[]})}get endpoints(){return void 0!==this._endpointsCache||(this._endpointsCache=this.build()),this._endpointsCache}middleware(){const e=new s;for(const t of this.endpoints)c(t,e);return e.middleware()}openApiDocument(e){const t=new r;for(const e of this.endpoints)l(e,t);return new o(t.definitions).generateDocument({openapi:"3.0.0",info:e})}}export{m as App};
//# sourceMappingURL=index.esm.js.map
